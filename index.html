<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דשבורד השקעות אישי</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            padding: 2rem;
            min-height: 100vh;
        }

        h1 {
            font-weight: 900;
            font-size: 2.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- Grid Layout --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* --- Cards --- */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .card h2 {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card.summary-profit .value {
            color: var(--accent-green);
        }

        .card.summary-loss .value {
            color: var(--accent-red);
        }

        /* --- Charts Section --- */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
            width: 100%;
        }

        /* --- Table Section --- */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            /* Scrollable table */
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            background: rgba(15, 23, 42, 0.5);
            border: var(--glass-border);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            width: 300px;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            border-color: var(--accent-blue);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th,
        td {
            text-align: right;
            padding: 1rem;
            border-bottom: var(--glass-border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
            background: rgba(15, 23, 42, 0.95);
            /* Sticky header bg */
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .positive {
            color: var(--accent-green);
        }

        .negative {
            color: var(--accent-red);
        }
    </style>
</head>

<body>

    <!-- Login Overlay -->
    <div id="lockScreen" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(10px);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 9999; transition: opacity 0.5s;
    ">
        <h2 style="margin-bottom: 2rem; color: #fff;">הכנס קוד גישה</h2>
        <input type="password" id="pinInput" maxlength="4" placeholder="****" style="
            font-size: 2rem; padding: 0.5rem 1rem; text-align: center; border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2); background: transparent; color: #fff; width: 200px;
        ">
        <p id="errorMsg" style="color: #ef4444; margin-top: 1rem; opacity: 0; transition: opacity 0.3s;">קוד שגוי</p>
    </div>

    <!-- Main Content Wrapper -->
    <div id="mainContent" style="filter: blur(8px); transition: filter 0.5s;">
        <h1>דשבורד השקעות - אבא</h1>

        <div id="loading" style="text-align:center; color: var(--text-secondary);">טוען נתונים...</div>

        <div id="dashboardContent" style="display:none;">
            <!-- Summary Metrics -->
            <div class="dashboard-grid">
                <div class="card summary-profit" id="card-total-pl">
                    <h2>סה"כ רווח/הפסד (מנוכה)</h2>
                    <div class="value">₪0</div>
                </div>
                <div class="card">
                    <h2>סה"כ עמלות ששולמו</h2>
                    <div class="value" id="val-fees">₪0</div>
                </div>
                <div class="card">
                    <h2>סה"כ מס שנוכה (בארץ ובחו"ל)</h2>
                    <div class="value" id="val-tax">₪0</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-container">
                <!-- Top 10 P/L -->
                <div class="card">
                    <h2>10 הניירות הכי משמעותיים (רווח/הפסד)</h2>
                    <div class="chart-wrapper">
                        <canvas id="plChart"></canvas>
                    </div>
                </div>
                <!-- Currency Pie -->
                <div class="card">
                    <h2>התפלגות מטבע (מס' עסקאות)</h2>
                    <div class="chart-wrapper">
                        <canvas id="currencyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card">
                <div class="controls">
                    <h2>פירוט עסקאות</h2>
                    <input type="text" id="searchInput" placeholder="חפש לפי שם נייר ערך...">
                </div>
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>תאריך</th>
                                <th>שם ני"ע</th>
                                <th>פעולה</th>
                                <th>כמות</th>
                                <th>שער</th>
                                <th>מטבע</th>
                                <th>עמלה</th>
                                <th>רווח/הפסד</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- JS Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div style="text-align: center; margin-top: 2rem; color: var(--text-secondary); font-size: 0.8rem;">
                עודכן לאחרונה: <span id="lastUpdated"></span> | מבוסס על Python Analysis
            </div>
        </div>
    </div>

    <script>
        // --- Lock Screen Logic ---
        const PIN = '1234';
        const pinInput = document.getElementById('pinInput');

        // Focus once loaded
        window.setTimeout(() => pinInput.focus(), 100);

        pinInput.addEventListener('input', (e) => {
            const val = e.target.value;
            if (val.length === 4) {
                if (val === PIN) {
                    unlockDashboard();
                } else {
                    showError();
                    e.target.value = '';
                }
            }
        });

        function unlockDashboard() {
            document.getElementById('lockScreen').style.opacity = '0';
            document.getElementById('mainContent').style.filter = 'none';
            setTimeout(() => {
                document.getElementById('lockScreen').style.display = 'none';
            }, 500);
        }

        function showError() {
            const err = document.getElementById('errorMsg');
            err.style.opacity = '1';
            setTimeout(() => err.style.opacity = '0', 2000);
        }

        // --- Data Logic ---
        const fmtMoney = (num) => new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }).format(num);
        const fmtNum = (num) => new Intl.NumberFormat('he-IL').format(num);
        
        let allTransactions = [];

        async function loadDashboardData() {
            try {
                const response = await fetch('dashboard_data.json');
                if (!response.ok) throw new Error("Failed to load data");
                const data = await response.json();
                
                renderDashboard(data);
            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerText = "שגיאה בטעינת נתונים: " + error.message;
            }
        }

        function renderDashboard(data) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // 1. Summary Metrics
            const summary = data.summary;
            
            const cardPL = document.getElementById('card-total-pl');
            cardPL.querySelector('.value').textContent = fmtMoney(summary.total_pl);
            cardPL.className = `card ${summary.total_pl >= 0 ? 'summary-profit' : 'summary-loss'}`;

            document.getElementById('val-fees').textContent = fmtMoney(summary.total_fees);
            document.getElementById('val-tax').textContent = fmtMoney(summary.total_tax);
            document.getElementById('lastUpdated').textContent = new Date(data.metadata.generated_at).toLocaleString('he-IL');

            // 2. Charts
            renderPLChart(data.charts.pl_by_security);
            renderCurrencyChart(data.charts.currency_distribution);

            // 3. Table
            allTransactions = data.transactions;
            renderTable(allTransactions);

            // Search Listener
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allTransactions.filter(row => 
                    row['שם ני"ע'] && row['שם ני"ע'].toString().toLowerCase().includes(term)
                );
                renderTable(filtered);
            });
        }

        function renderPLChart(items) {
            const ctx = document.getElementById('plChart').getContext('2d');
            const colors = items.map(d => d.val >= 0 ? '#10b981' : '#ef4444');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: items.map(d => d.name),
                    datasets: [{
                        label: 'רווח/הפסד (₪)',
                        data: items.map(d => d.val),
                        backgroundColor: colors,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { display: false } },
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                    }
                }
            });
        }

        function renderCurrencyChart(dataObj) {
            const ctx = document.getElementById('currencyChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataObj.labels,
                    datasets: [{
                        data: dataObj.data,
                        backgroundColor: ['#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#cbd5e1' } } },
                    cutout: '60%'
                }
            });
        }

        function renderTable(rows) {
            const tbody = document.querySelector('#transactionsTable tbody');
            tbody.innerHTML = '';

            rows.forEach(row => {
                const tr = document.createElement('tr');
                const pl = parseFloat(row['רווח/הפסד']) || 0;
                const plClass = pl > 0 ? 'positive' : (pl < 0 ? 'negative' : '');
                
                tr.innerHTML = `
                    <td>${row['תאריך ביצוע']}</td>
                    <td style="font-weight: 500">${row['שם ני"ע']}</td>
                    <td>${row['פעולה']}</td>
                    <td>${fmtNum(row['כמות ביצוע'])}</td>
                    <td>${fmtNum(row['שער ביצוע'])}</td>
                    <td>${row['מטבע']}</td>
                    <td class="negative">${fmtNum(row['עמלות ודמי ניהול'])}</td>
                    <td class="${plClass}" style="direction: ltr">${fmtNum(pl)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Init
        window.onload = loadDashboardData;

    </script>
</body>

</html>