<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Dashboard</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            padding: 2rem;
            min-height: 100vh;
        }

        /* Tabs Navigation */
        .nav-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: var(--glass-border);
            margin-bottom: 2rem;
            padding-bottom: 0.5rem;
        }

        .nav-tab {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .nav-tab.active {
            color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
            font-weight: 700;
        }

        /* Content Sections */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-weight: 900;
            font-size: 2.5rem;
            margin-bottom: 0;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- Grid Layout --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* --- Cards --- */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .card h2 {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card.summary-profit .value {
            color: var(--accent-green);
        }

        .card.summary-loss .value {
            color: var(--accent-red);
        }

        /* --- Charts Section --- */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {

            .charts-container,
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
            width: 100%;
        }

        /* --- Table Section --- */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            background: rgba(15, 23, 42, 0.5);
            border: var(--glass-border);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            width: 300px;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            border-color: var(--accent-blue);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        th,
        td {
            text-align: left;
            padding: 1rem;
            border-bottom: var(--glass-border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            background: rgba(15, 23, 42, 0.95);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            font-variant-numeric: tabular-nums;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .positive {
            color: var(--accent-green);
        }

        .negative {
            color: var(--accent-red);
        }
    </style>
</head>

<body>

    <!-- Login Overlay -->
    <div id="lockScreen" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(10px);
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        z-index: 9999; transition: opacity 0.5s;
    ">
        <h2 style="margin-bottom: 2rem; color: #fff;">Enter Access Code</h2>
        <input type="password" id="pinInput" maxlength="4" placeholder="****" style="
            font-size: 2rem; padding: 0.5rem 1rem; text-align: center; border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2); background: transparent; color: #fff; width: 200px;
        ">
        <p id="errorMsg" style="color: #ef4444; margin-top: 1rem; opacity: 0; transition: opacity 0.3s;">Incorrect PIN
        </p>
    </div>

    <!-- Main Content Wrapper -->
    <div id="mainContent" style="filter: blur(8px); transition: filter 0.5s;">

        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h1>Investment Dashboard</h1>
                <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                    Dad's Portfolio Analysis
                </div>
            </div>
            <div id="versionDisplay" style="color: rgba(255,255,255,0.3); font-family: monospace; font-size: 0.9rem;">
                v<span id="verNum">--</span>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">Overview</button>
            <button class="nav-tab" onclick="switchTab('transactions')">Transactions</button>
            <button class="nav-tab" onclick="switchTab('whatif')">What If Analysis</button>
        </div>

        <div id="loading" style="text-align:center; color: var(--text-secondary); margin-top: 4rem;">Loading Data...
        </div>

        <!-- TAB: OVERVIEW -->
        <div id="tab-overview" class="tab-content active">
            <!-- Summary Metrics -->
            <div class="dashboard-grid">
                <div class="card summary-profit" id="card-total-pl">
                    <h2>Total P/L (Net)</h2>
                    <div class="value">₪0</div>
                </div>
                <div class="card">
                    <h2>Total Fees Paid</h2>
                    <div class="value" id="val-fees">₪0</div>
                </div>
                <div class="card">
                    <h2>Total Tax Deducted</h2>
                    <div class="value" id="val-tax">₪0</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-container">
                <div class="card">
                    <h2>Top Performers (P/L Impact)</h2>
                    <div class="chart-wrapper">
                        <canvas id="plChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h2>Currency Exposure (Transaction Count)</h2>
                    <div class="chart-wrapper">
                        <canvas id="currencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: TRANSACTIONS -->
        <div id="tab-transactions" class="tab-content">
            <div class="card">
                <div class="controls">
                    <h2>Transaction History</h2>
                    <input type="text" id="searchInput" placeholder="Search by symbol...">
                </div>
                <div class="table-container">
                    <table id="transactionsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Action</th>
                                <th style="text-align: right;">Qty</th>
                                <th style="text-align: right;">Price</th>
                                <th>Currency</th>
                                <th style="text-align: right;">Fees</th>
                                <th style="text-align: right;">P/L</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB: WHAT IF -->
        <div id="tab-whatif" class="tab-content">
            <div class="dashboard-grid">
                <div class="card" id="card-opportunity">
                    <h2>Missed Opportunity (If Held)</h2>
                    <div class="value">--</div>
                    <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">
                        * Calculation: (Current Price - Sale Price) × Quantity
                    </div>
                </div>

                <!-- Top Regrets -->
                <div class="card" style="grid-column: span 1;">
                    <h2 style="color: #ef4444;">Missed Gains (Price went UP)</h2>
                    <div class="table-container" style="max-height: 250px;">
                        <table id="tableRegrets">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th style="text-align: right;">Missed</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Smart Moves -->
                <div class="card" style="grid-column: span 1;">
                    <h2 style="color: #10b981;">Smart Sells (Price went DOWN)</h2>
                    <div class="table-container" style="max-height: 250px;">
                        <table id="tableSmart">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th style="text-align: right;">Saved</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <div class="controls">
                    <h2>Opportunity Details</h2>
                </div>
                <div class="table-container" style="max-height: 600px;">
                    <table id="tableOpportunities">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th style="text-align:right;">Sold @</th>
                                <th style="text-align:right;">Current</th>
                                <th style="text-align:right;">Diff/Share</th>
                                <th style="text-align:right;">Total Missed</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div
            style="text-align: center; margin-top: 3rem; color: var(--text-secondary); font-size: 0.8rem; border-top: var(--glass-border); padding-top: 1rem;">
            Last Updated: <span id="lastUpdated"></span> | Powered by Python Analysis
        </div>
    </div>

    <script>
        // --- Navigation Logic ---
        function switchTab(tabName) {
            // Update Buttons
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            // Find button that calls this tab (hacky but works for simple case)
            const btns = document.querySelectorAll('.nav-tab');
            if (tabName === 'overview') btns[0].classList.add('active');
            if (tabName === 'transactions') btns[1].classList.add('active');
            if (tabName === 'whatif') btns[2].classList.add('active');

            // Update Content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // --- Lock Screen Logic ---
        const PIN = '1234';
        const pinInput = document.getElementById('pinInput');
        window.setTimeout(() => pinInput.focus(), 100);

        pinInput.addEventListener('input', (e) => {
            if (e.target.value === PIN) {
                document.getElementById('lockScreen').style.opacity = '0';
                document.getElementById('mainContent').style.filter = 'none';
                setTimeout(() => document.getElementById('lockScreen').style.display = 'none', 500);
            } else if (e.target.value.length === 4) {
                const err = document.getElementById('errorMsg');
                err.style.opacity = '1';
                setTimeout(() => err.style.opacity = '0', 2000);
                e.target.value = '';
            }
        });

        // --- Data Logic ---
        const fmtMoney = (num, currency = 'ILS') => new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, maximumFractionDigits: 0 }).format(num);
        const fmtNum = (num) => new Intl.NumberFormat('en-US').format(num);

        let allTransactions = [];

        async function loadDashboardData() {
            const loading = document.getElementById('loading');
            try {
                loading.innerText = "Status: Starting...";

                loading.innerText = "Status: Fetching Data...";
                const response = await fetch('dashboard_data.json');

                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);

                loading.innerText = "Status: Parsing JSON...";
                const data = await response.json();

                loading.innerText = "Status: Rendering...";
                renderDashboard(data);
            } catch (error) {
                console.error(error);
                loading.innerText = "Error: " + error.message + "\n" + (error.stack || '');
                loading.style.color = '#ef4444';
            }
        }

        function renderDashboard(data) {
            document.getElementById('loading').style.display = 'none';

            // 1. Summary Metrics
            const summary = data.summary;
            const cardPL = document.getElementById('card-total-pl');
            cardPL.querySelector('.value').textContent = fmtMoney(summary.total_pl);
            cardPL.className = `card ${summary.total_pl >= 0 ? 'summary-profit' : 'summary-loss'}`;

            document.getElementById('val-fees').textContent = fmtMoney(summary.total_fees);
            document.getElementById('val-tax').textContent = fmtMoney(summary.total_tax);
            document.getElementById('lastUpdated').textContent = new Date(data.metadata.generated_at).toLocaleString('en-US');

            // Version
            if (data.metadata.version) {
                document.getElementById('verNum').textContent = data.metadata.version;
            }

            // 2. Overview Charts
            renderPLChart(data.charts.pl_by_security);
            renderCurrencyChart(data.charts.currency_distribution);

            // 3. Transactions Table
            allTransactions = data.transactions;
            renderTable(allTransactions);
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allTransactions.filter(row =>
                    row.symbol && row.symbol.toString().toLowerCase().includes(term)
                );
                renderTable(filtered);
            });

            // 4. What If Analysis
            if (data.what_if) {
                renderWhatIf(data.what_if);
            }
        }

        function renderTable(rows) {
            const tbody = document.querySelector('#transactionsTable tbody');
            tbody.innerHTML = '';

            if (!rows || rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 2rem; color: #94a3b8;">No transactions found.</td></tr>`;
                return;
            }

            rows.forEach(row => {
                const tr = document.createElement('tr');
                const pl = parseFloat(row.profit_loss) || 0;
                const plClass = pl > 0 ? 'positive' : (pl < 0 ? 'negative' : '');

                tr.innerHTML = `
                    <td>${row.date || ''}</td>
                    <td style="font-weight: 500">${row.symbol || '-'}</td>
                    <td>${row.action || '-'}</td>
                    <td style="text-align: right;">${fmtNum(row.quantity)}</td>
                    <td style="text-align: right;">${fmtNum(row.price)}</td>
                    <td>${row.currency || ''}</td>
                    <td class="negative" style="text-align: right;">${fmtNum(row.fees)}</td>
                    <td class="${plClass}" style="text-align: right;">${fmtNum(pl)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderWhatIf(whatIfData) {
            // Total Opportunity Cost
            const totalMissed = whatIfData.opportunities.reduce((acc, curr) => acc + curr.total_missed, 0);
            const cardOpp = document.getElementById('card-opportunity');
            const valEl = cardOpp.querySelector('.value');

            if (totalMissed > 0) {
                valEl.textContent = `-${fmtMoney(totalMissed, 'USD').replace('$', '')}`; // Check currency later
                valEl.textContent = `-${fmtNum(totalMissed)}`;
                valEl.style.color = '#ef4444';
                cardOpp.querySelector('h2').textContent = "Missed Potential Profit";
            } else {
                valEl.textContent = `+${fmtNum(Math.abs(totalMissed))}`;
                valEl.style.color = '#10b981';
                cardOpp.querySelector('h2').textContent = "Loss Avoided (Saved)";
            }

            // Tables
            const renderMini = (id, list) => {
                const tbody = document.querySelector(`#${id} tbody`);
                tbody.innerHTML = '';
                list.forEach(item => {
                    const tr = document.createElement('tr');
                    const val = Math.abs(item.total_missed);
                    const sym = item.currency === 'USD' ? '$' : (item.currency === 'ILS' ? '₪' : '');
                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:bold;">${item.name}</div>
                            <div style="font-size:0.8em; color:#94a3b8;">${item.date}</div>
                        </td>
                        <td style="text-align:right; font-weight:bold;">${sym}${fmtNum(val)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            };

            renderMini('tableRegrets', whatIfData.top_regrets);
            renderMini('tableSmart', whatIfData.top_smart_moves);

            // Full Opp Table
            const tbodyOpp = document.querySelector('#tableOpportunities tbody');
            tbodyOpp.innerHTML = '';
            whatIfData.opportunities.forEach(item => {
                const tr = document.createElement('tr');
                const val = item.total_missed;
                const plClass = val < 0 ? 'positive' : 'negative'; // Negative missed is good (saved)
                tr.innerHTML = `
                     <td>${item.date}</td>
                     <td>${item.name}</td>
                     <td style="text-align:right;">${fmtNum(item.sale_price)}</td>
                     <td style="text-align:right;">${fmtNum(item.current_price)}</td>
                     <td style="text-align:right;">${fmtNum(item.diff_per_unit)}</td>
                     <td class="${plClass}" style="text-align:right;">${fmtNum(val)}</td>
                `;
                tbodyOpp.appendChild(tr);
            });
        }

        function renderPLChart(items) {
            const ctx = document.getElementById('plChart').getContext('2d');
            const colors = items.map(d => d.val >= 0 ? '#10b981' : '#ef4444');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: items.map(d => d.name),
                    datasets: [{
                        label: 'P/L',
                        data: items.map(d => d.val),
                        backgroundColor: colors,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#94a3b8', font: { size: 10 } }, grid: { display: false } },
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255, 255, 255, 0.05)' } }
                    }
                }
            });
        }

        function renderCurrencyChart(dataObj) {
            const ctx = document.getElementById('currencyChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: dataObj.labels,
                    datasets: [{
                        data: dataObj.data,
                        backgroundColor: ['#3b82f6', '#f59e0b', '#8b5cf6', '#ec4899', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#cbd5e1' } } },
                    cutout: '60%'
                }
            });
        }

        // Init
        function initDashboard() {
            // Prevent multiple inits
            if (window.dashboardInitialized) return;
            window.dashboardInitialized = true;

            const loading = document.getElementById('loading');
            if (loading) loading.innerText = "Status: JS Active, Starting...";

            loadDashboardData();
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            initDashboard();
        }

        // Fallback for extreme cases
        setTimeout(initDashboard, 1000);

    </script>
</body>

</html>